<!DOCTYPE html>
<html lang="zh-cn">
<head>
  <meta charset="UTF-8" />
  <title>TKCall后台管理</title>
  <link rel="stylesheet" href="./admin.css" />
  <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
  <style>
    .admin-login-modal {
      z-index: 9999; position: fixed; left: 0; top: 0; width: 100vw; height: 100vh;
      background: rgba(0,0,0,0.25); display: flex; align-items: center; justify-content: center;
    }
    .admin-login-box {
      background: #fff; border-radius: 12px; box-shadow: 0 2px 30px #b3cfc9;
      padding: 32px 30px; min-width: 320px;
    }
    .admin-login-box h2 { color: #88af8e; text-align: center; margin-bottom: 14px; }
    .admin-login-box input { width: 100%; margin-bottom: 13px; padding: 10px 13px; border-radius: 7px; border: 1px solid #ddd; font-size: 16px; }
    .admin-login-box button { width: 100%; background: #88af8e; color: #fff; font-size: 16px; border: none; border-radius: 7px; padding: 11px 0; cursor: pointer; }
    .admin-login-msg { color: #c00; text-align: center; margin-bottom: 10px; font-size: 15px; }
    .admin-logout-btn { background: #eee; color: #88af8e; border: 1px solid #88af8e; border-radius: 7px; margin-left: 14px; font-size: 15px; padding: 7px 18px; cursor: pointer; }
  </style>
</head>
<body>
  <header class="admin-header">
    <div class="admin-header-inner">
      <div class="admin-logo">
        <img class="logo-img" src="https://cdn.tkcall.com/original/1X/f7179d7be06f3e071b52597b87b06d1ef9af30e5.png" alt="logo" />
        <span class="logo-title">TKCall后台管理</span>
        <button id="adminLogoutBtn" class="admin-logout-btn" style="display:none;">退出登录</button>
      </div>
      <nav class="admin-menu">
        <a class="admin-menu-link active" href="#" data-tab="nav">导航管理</a>
        <a class="admin-menu-link" href="#" data-tab="cat">分类管理</a>
      </nav>
    </div>
  </header>
  <div class="admin-container">
    <aside class="admin-sidebar">
      <nav class="admin-sidebar-list">
        <button class="admin-sidebar-item active" data-tab="nav">导航管理</button>
        <button class="admin-sidebar-item" data-tab="cat">分类管理</button>
      </nav>
    </aside>
    <main class="admin-main-content">
      <section id="tab-nav" class="admin-tab active">
        <h2>导航管理</h2>
        <div id="nav-list"></div>
      </section>
      <section id="tab-cat" class="admin-tab">
        <h2>分类管理</h2>
        <div id="cat-list"></div>
      </section>
    </main>
  </div>
  <footer>
    <p>© 2025 TKCall后台管理</p>
  </footer>

  <!-- 登录弹窗 -->
  <div id="adminLoginModal" class="admin-login-modal" style="display:none;">
    <div class="admin-login-box">
      <h2>后台登录</h2>
      <div class="admin-login-msg" id="adminLoginMsg"></div>
      <input id="adminLoginUser" type="text" placeholder="用户名" autocomplete="username" />
      <input id="adminLoginPwd" type="password" placeholder="密码" autocomplete="current-password" />
      <button id="adminLoginBtn">登录</button>
    </div>
  </div>

  <script src="./admin.js"></script>
  <script>
    // 登录流程
    async function showLoginModal(msg) {
      document.getElementById('adminLoginModal').style.display = 'flex';
      document.getElementById('adminLoginMsg').textContent = msg || '';
      document.getElementById('adminLogoutBtn').style.display = 'none';
    }
    function hideLoginModal() {
      document.getElementById('adminLoginModal').style.display = 'none';
      document.getElementById('adminLogoutBtn').style.display = '';
    }
    async function verifyToken() {
      const token = localStorage.getItem('adminToken');
      if (!token) return false;
      // 用一个后台API验证token有效性
      try {
        const resp = await fetch('/api/admin-verify-token', {
          method: 'POST',
          headers: { 'Authorization': 'Bearer ' + token }
        });
        if (resp.status === 401) return false;
        return true;
      } catch (e) { return false; }
    }
    async function ensureLogin() {
      if (!await verifyToken()) {
        showLoginModal();
        return false;
      } else {
        hideLoginModal();
        return true;
      }
    }

    // 登录弹窗事件
    document.getElementById('adminLoginBtn').onclick = async function () {
      const username = document.getElementById('adminLoginUser').value.trim();
      const password = document.getElementById('adminLoginPwd').value;
      const msgEl = document.getElementById('adminLoginMsg');
      msgEl.textContent = '';
      if (!username || !password) {
        msgEl.textContent = '请输入用户名和密码';
        return;
      }
      const resp = await fetch('/api/admin-login', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ username, password })
      });
      const data = await resp.json();
      if (resp.ok && data.token) {
        localStorage.setItem('adminToken', data.token);
        hideLoginModal();
        location.reload(); // 刷新加载内容
      } else {
        msgEl.textContent = data.msg || '登录失败';
      }
    };

    // 退出登录
    document.getElementById('adminLogoutBtn').onclick = function () {
      localStorage.removeItem('adminToken');
      location.reload();
    };

    // 页面加载时强制登录验证
    (async function () {
      if (!await ensureLogin()) return;
      // 显示退出登录按钮
      document.getElementById('adminLogoutBtn').style.display = '';
      // 后续 admin.js 里的所有 fetch 带上 token
      window.adminToken = localStorage.getItem('adminToken');
    })();
  </script>
</body>
</html>
